<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Player Comercial</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    /* Estilos Globais e Reset */
    html, body {
      margin: 0; padding: 0; background: black; overflow: hidden;
      width: 100vw; height: 100vh; font-family: 'Montserrat', sans-serif;
      display: flex; justify-content: center; align-items: center;
    }

    #player-wrapper {
      width: 1920px; height: 1080px;
      position: relative; background: black;
      box-shadow: 0 0 20px rgba(0,0,0,0.8);
      -webkit-transform-origin: center center;
      transform-origin: center center;
    }

    #mainMediaWrapper {
      width: 100%; height: 100%;
      position: relative; background: black;
    }

    #media, #fallback {
      width: 100%; height: 100%;
      object-fit: cover;
      position: absolute; top: 0; left: 0;
    }

    /* Estilos da Barra de Informações */
    #barra {
      position: absolute; bottom: 12px; left: 50%;
      width: 97%; background: rgba(0, 0, 0, 0.75);
      padding: 20px; display: flex;
      justify-content: space-between; align-items: center;
      font-size: 15px; color: #ffffff;
      z-index: 10; /* Z-INDEX ADICIONADO AQUI */
      -webkit-transform: translateX(-50%);
      transform: translateX(-50%);
      -webkit-border-radius: 26px;
      border-radius: 26px;
    }
    #infoAlternada { display: flex; align-items: center; gap: 20px; transition: opacity 0.6s ease; }
    .relogio { font-size: 30px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
    .logo-eletromidia { height: 48px; max-width: 200px; object-fit: contain; margin-right: 24px; }
    .icon-decorado { width: 20px; height: 20px; background: #ffffff; padding: 4px; border-radius: 6px; filter: brightness(0.50) invert(1); }
    
    /* Estilos do Menu de Controles */
    #controls-container {
      position: fixed; top: 50%; left: 50%;
      z-index: 200; display: none;
      -webkit-transform: translate(-50%, -50%);
      transform: translate(-50%, -50%);
    }
    .menu-grid {
      list-style: none; margin: 0; padding: 0;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      border: 1px solid #4a4e69;
    }
    .menu-grid li {
      width: 160px; height: 130px; display: flex;
      justify-content: center; align-items: center;
      border: 1px solid #4a4e69;
      background-color: rgba(34, 34, 59, 0.95);
      cursor: pointer;
      -webkit-transition: background-color 0.4s ease-in-out;
      transition: background-color 0.4s ease-in-out;
    }
    .menu-grid li:hover { background-color: #4a4e69; }
    .menu-grid li a {
      text-decoration: none; display: flex; flex-direction: column;
      align-items: center; justify-content: center; color: #FFF;
      font-size: 16px; text-transform: capitalize; text-align: center;
      width: 100%; height: 100%;
    }
    .menu-grid li i { margin-bottom: 15px; }
  </style>
</head>
<body>

  <div id="player-wrapper">
    <div id="mainMediaWrapper">
      <video id="media" autoplay muted playsinline></video>
      <img id="fallback" style="display: none;">
      <div id="barra">
        <div id="infoAlternada">
          <img src='https://cdn-icons-png.flaticon.com/512/3358/3358623.png' class='icon-decorado' alt='Ícone Inicial'>Carregando...
        </div>
        <div class="relogio">
          <img src="../img/logo-branca.png" alt="Logo" class="logo-eletromidia" onerror="this.onerror=null; this.src='https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTSngqZzv7e6QBJRAN9L8zXvB9deAVNWW6tXQ&s';">
          <span id="hora"></span>
        </div>
      </div>
    </div>
  </div>

  <input type="file" id="mediaInput" accept="video/mp4,image/*" multiple style="display: none;">

  <div id="controls-container">
    <ul class="menu-grid">
      <li><a href="#" onclick="addMedia()"><i class="fa fa-plus fa-2x"></i>Add Mídia</a></li>
      <li><a href="#" onclick="toggleFullscreen()"><i class="fa fa-expand fa-2x"></i>Tela Cheia</a></li>
      <li><a href="#" onclick="toggleBar()"><i class="fa fa-bars fa-2x"></i>Alternar Barra</a></li>
      <li><a href="#" onclick="reloadMidia()"><i class="fa fa-sync-alt fa-2x"></i>Recarregar</a></li>
      <li><a href="#" onclick="resetMidias()"><i class="fa fa-trash fa-2x"></i>Resetar</a></li>
      <li><a href="#" onclick="rotatePlayer()"><i class="fa fa-redo fa-2x"></i>Rotacionar</a></li>
      <li><a href="#" onclick="zoomIn()"><i class="fa fa-search-plus fa-2x"></i>Zoom +</a></li>
      <li><a href="#" onclick="zoomOut()"><i class="fa fa-search-minus fa-2x"></i>Zoom -</a></li>
      <li><a href="#" onclick="ajustarTextoAlternado('left')"><i class="fa fa-chevron-left fa-2x"></i>Ajustar Info</a></li>
      <li><a href="#" onclick="ajustarTextoAlternado('right')"><i class="fa fa-chevron-right fa-2x"></i>Ajustar Info</a></li>
      <li><a href="#" onclick="moveTemplate('up')"><i class="fa fa-arrow-up fa-2x"></i>Mover Cima</a></li>
      <li><a href="#" onclick="moveTemplate('down')"><i class="fa fa-arrow-down fa-2x"></i>Mover Baixo</a></li>
      <li><a href="#" onclick="moveTemplate('left')"><i class="fa fa-arrow-left fa-2x"></i>Mover Esq.</a></li>
      <li><a href="#" onclick="moveTemplate('right')"><i class="fa fa-arrow-right fa-2x"></i>Mover Dir.</a></li>
      <li><a href="#" onclick="toggleControls()"><i class="fa fa-eye-slash fa-2x"></i>Ocultar Menu</a></li>
      <li><a href="#" onclick="stretchTemplate('horizontal+')"><i class="fa fa-arrows-alt-h fa-2x"></i>Largura +</a></li>
      <li><a href="#" onclick="stretchTemplate('horizontal-')"><i class="fa fa-compress-arrows-alt fa-2x"></i>Largura -</a></li>
      <li><a href="#" onclick="stretchTemplate('vertical+')"><i class="fa fa-arrows-alt-v fa-2x"></i>Altura +</a></li>
      <li><a href="#" onclick="stretchTemplate('vertical-')"><i class="fa fa-compress-arrows-alt fa-2x"></i>Altura -</a></li>
      <li><a href="#" onclick="lerGradePasta()"><i class="fa fa-folder-open fa-2x"></i>Ler Grade</a></li>
    </ul>
  </div>

<script>
    // --- VARIÁVEIS GLOBAIS ---
    const wrapper = document.getElementById('player-wrapper');
    const media = document.getElementById('media');
    const fallback = document.getElementById('fallback'); // Referência para a tag de imagem
    const mediaInput = document.getElementById('mediaInput');
    const controlsContainer = document.getElementById('controls-container');
    const infoAlternadaEl = document.getElementById('infoAlternada');
    
    let mainPlaylist = [], mainIndex = 0;
    let zoom = 1, rotation = 0;
    let imageTimeout; // Variável para controlar o tempo de exibição da imagem
    
    // --- (NOVO) VARIÁVEIS DE CONTROLE DA GRADE ---
    let gradeDirectoryHandle = null; // Armazena o "handle" (referência) da pasta
    let gradeCheckInterval = null;   // Armazena o timer do monitoramento
    const GRADE_CHECK_INTERVAL_MS = 10000; // Verificar a pasta a cada 10 segundos

    // --- FUNÇÕES DE CONTROLE ---
    function toggleControls() { controlsContainer.style.display = (controlsContainer.style.display === 'block') ? 'none' : 'block'; }
    function toggleBar() { document.getElementById('barra').style.display = (document.getElementById('barra').style.display === 'none') ? 'flex' : 'none'; }
    function toggleFullscreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
    function addMedia() { mediaInput.click(); }
    
    /**
     * (MODIFICADO) Lógica de adicionar mídia.
     * Para o monitoramento de grade se mídias manuais forem adicionadas.
     */
    mediaInput.onchange = (event) => { 
        // --- (MODIFICADO) Interrompe o monitoramento de grade
        if (gradeCheckInterval) {
            clearInterval(gradeCheckInterval);
            gradeCheckInterval = null;
            gradeDirectoryHandle = null;
            console.log("Monitoramento de grade interrompido. Carregando mídias manuais.");
        }
    
        const files = Array.from(event.target.files); 
        const wasEmpty = mainPlaylist.length === 0; // Verifica o estado *antes* de adicionar
        mainPlaylist = mainPlaylist.concat(files); 
        
        // Se estava vazia e agora tem ficheiros, inicia a reprodução.
        if (wasEmpty && mainPlaylist.length > 0) {
            loadMainMedia(); 
        }
        event.target.value = null; // Limpa o input
    };

    // --- LÓGICA DE MÍDIA MODIFICADA ---

    /**
     * @description Avança para o próximo item na playlist e o carrega.
     * Esta função agora é separada para ser chamada tanto pelo fim de um vídeo quanto pelo temporizador de uma imagem.
     */
    function advancePlaylist() {
        if (mainPlaylist.length > 0) {
            // O operador % (módulo) garante o loop infinito
            mainIndex = (mainIndex + 1) % mainPlaylist.length;
            loadMainMedia();
        }
    }

    /**
     * @description Carrega a mídia atual (vídeo ou imagem) da playlist.
     * Foi modificada para verificar o tipo do ficheiro e exibir no elemento correto.
     */
    function loadMainMedia() {
        // Limpa qualquer temporizador de imagem anterior para evitar transições inesperadas
        if (imageTimeout) clearTimeout(imageTimeout);
        if (mainPlaylist.length === 0) return;

        const file = mainPlaylist[mainIndex];
        
        // --- (NOVO) Adicionado tratamento de erro caso o 'file' seja inválido ---
        if (!file) {
            console.error("Tentativa de carregar mídia inválida no índice:", mainIndex);
            // Tenta avançar para a próxima mídia para não parar o player
            advancePlaylist();
            return;
        }
        
        const url = URL.createObjectURL(file);

        // Verifica se o ficheiro é um vídeo
        if (file.type.startsWith('video/')) {
            media.style.display = 'block'; // Mostra o player de vídeo
            fallback.style.display = 'none'; // Esconde a imagem
            media.src = url;
            media.play().catch(e => console.error("Erro ao reproduzir vídeo:", e));
        } 
        // Verifica se o ficheiro é uma imagem
        else if (file.type.startsWith('image/')) {
            fallback.style.display = 'block'; // Mostra a imagem
            media.style.display = 'none'; // Esconde o player de vídeo
            media.pause(); // Pausa o vídeo por segurança
            media.src = ''; // Limpa a fonte do vídeo
            fallback.src = url;

            // Define um tempo de 5 segundos para exibir a imagem antes de avançar
            const IMAGE_DURATION = 5000; // 5000 ms = 5 segundos
            imageTimeout = setTimeout(advancePlaylist, IMAGE_DURATION);
        }
    }

    // O evento 'ended' do vídeo agora chama a função de avanço
    media.addEventListener('ended', advancePlaylist);

    function reloadMidia() { if (mainPlaylist.length > 0) { mainIndex = 0; loadMainMedia(); } }
    
    /**
     * (MODIFICADO) Reseta a playlist.
     * Agora também limpa o temporizador de imagem e o monitoramento de grade.
     */
    function resetMidias() { 
        // --- (MODIFICADO) Interrompe o monitoramento de grade
        if (gradeCheckInterval) {
            clearInterval(gradeCheckInterval);
            gradeCheckInterval = null;
            gradeDirectoryHandle = null;
            console.log("Monitoramento de grade interrompido.");
        }
    
        if (imageTimeout) clearTimeout(imageTimeout); // Garante que o timer da imagem pare
        mainPlaylist = []; 
        mainIndex = 0; 
        media.pause(); 
        media.removeAttribute('src'); 
        media.load(); 
        fallback.style.display = 'none'; 
        fallback.removeAttribute('src'); 
    }
    
    function rotatePlayer() { rotation = (rotation + 90) % 360; wrapper.style.transform = `scale(${zoom}) rotate(${rotation}deg)`; }
    function zoomIn() { zoom += 0.02; wrapper.style.transform = `scale(${zoom}) rotate(${rotation}deg)`; }
    function zoomOut() { zoom = Math.max(0.1, zoom - 0.02); wrapper.style.transform = `scale(${zoom}) rotate(${rotation}deg)`; }
    function moveTemplate(direcao) { const style = window.getComputedStyle(wrapper); const marginTop = parseInt(style.marginTop || 0); const marginLeft = parseInt(style.marginLeft || 0); if (direcao === 'up') wrapper.style.marginTop = (marginTop - 10) + 'px'; if (direcao === 'down') wrapper.style.marginTop = (marginTop + 10) + 'px'; if (direcao === 'left') wrapper.style.marginLeft = (marginLeft - 10) + 'px'; if (direcao === 'right') wrapper.style.marginLeft = (marginLeft + 10) + 'px'; }
    function stretchTemplate(tipo) { if (tipo === 'horizontal+') wrapper.style.width = (wrapper.offsetWidth + 20) + 'px'; if (tipo === 'horizontal-') wrapper.style.width = Math.max(100, wrapper.offsetWidth - 20) + 'px'; if (tipo === 'vertical+') wrapper.style.height = (wrapper.offsetHeight + 20) + 'px'; if (tipo === 'vertical-') wrapper.style.height = Math.max(100, wrapper.offsetHeight - 20) + 'px'; }
    function ajustarTextoAlternado(direcao) { const estiloAtual = parseInt(infoAlternadaEl.style.marginLeft || 0); infoAlternadaEl.style.marginLeft = `${estiloAtual + (direcao === 'left' ? -10 : 10)}px`; }
    document.addEventListener('keydown', (e) => { if (e.key.toLowerCase() === 'm') { toggleControls(); } });

    // --- (NOVAS) FUNÇÕES DE LEITURA DE GRADE ---

    /**
     * Inicia o processo de seleção de pasta para monitoramento.
     * Esta função é assíncrona (async) pois espera o utilizador escolher a pasta.
     */
    async function lerGradePasta() {
        // 1. Verifica se o navegador suporta a API (requer HTTPS ou localhost)
        if (!window.showDirectoryPicker) {
            alert('Erro: O seu navegador não suporta a seleção de pastas ou a página não está em HTTPS/localhost.');
            return;
        }

        try {
            // 2. Pede ao utilizador para selecionar uma pasta
            const handle = await window.showDirectoryPicker();
            
            // 3. Limpa qualquer playlist ou monitoramento anterior
            resetMidias(); 
            
            // 4. Armazena a referência da pasta
            gradeDirectoryHandle = handle;
            console.log(`Iniciando monitoramento da pasta: ${handle.name}`);

            // 5. Faz a primeira verificação imediatamente
            await scanGradeDirectory();
            
            // 6. Inicia o "timer" para verificar a pasta periodicamente
            gradeCheckInterval = setInterval(scanGradeDirectory, GRADE_CHECK_INTERVAL_MS);

        } catch (err) {
            // O utilizador pode ter cancelado a seleção
            console.error("Erro ao selecionar a pasta ou permissão negada:", err);
        }
    }

    /**
     * Verifica a pasta selecionada por arquivos de vídeo da grade.
     * Esta função é assíncrona (async) pois a leitura de arquivos é assíncrona.
     */
    async function scanGradeDirectory() {
        if (!gradeDirectoryHandle) return; // Sai se nenhuma pasta estiver selecionada

        let foundFiles = []; // Array para armazenar os "handles" dos arquivos encontrados
        
        try {
            // 1. Itera sobre todos os arquivos/pastas dentro da pasta selecionada
            for await (const entry of gradeDirectoryHandle.values()) {
                // 2. Verifica se é um arquivo (kind === 'file') e se o nome bate o padrão "video" + "numero" + ".mp4"
                // A expressão regular /i torna a verificação "case-insensitive" (ignora maiúsculas/minúsculas)
                if (entry.kind === 'file' && entry.name.match(/^video\d+\.mp4$/i)) {
                    foundFiles.push(entry);
                }
            }

            // 3. Ordena os arquivos numericamente
            foundFiles.sort((a, b) => {
                // Extrai o número do nome de cada arquivo
                const numA = parseInt(a.name.match(/(\d+)/)[1]);
                const numB = parseInt(b.name.match(/(\d+)/)[1]);
                return numA - numB; // Ordena do menor para o maior
            });

            // 4. Compara a lista encontrada com a playlist atual
            // Criamos "listas de nomes" para comparar facilmente
            const newPlaylistNames = foundFiles.map(f => f.name);
            const oldPlaylistNames = mainPlaylist.map(f => f.name);

            // 5. Verifica se as listas são diferentes
            // JSON.stringify é uma forma simples de comparar se os arrays são idênticos
            if (JSON.stringify(newPlaylistNames) !== JSON.stringify(oldPlaylistNames)) {
                console.log("Mudança na grade detetada. Atualizando playlist...");
                console.log("Arquivos encontrados:", newPlaylistNames.join(', '));
                
                // 6. Converte os "handles" de arquivo (FileSystemFileHandle) em objetos "File"
                // que a nossa função loadMainMedia() entende
                const fileObjects = await Promise.all(
                    foundFiles.map(fileHandle => fileHandle.getFile())
                );

                // 7. Atualiza a playlist principal
                mainPlaylist = fileObjects;
                
                // 8. Reinicia a playlist do início
                mainIndex = 0;
                loadMainMedia(); // <--- Esta é a função correta para este player
            }
            
        } catch (err) {
            console.error("Erro ao ler a pasta da grade. A permissão pode ter sido revogada.", err);
            // Para o monitoramento se houver um erro grave (ex: pasta apagada)
            resetMidias(); 
        }
    }

    // --- LÓGICA DA BARRA DE INFORMAÇÕES (Inalterada) ---
    function atualizarHora() { const horaEl = document.getElementById('hora'); if (!horaEl) return; const agora = new Date(); const h = agora.getHours().toString().padStart(2, '0'); const m = agora.getMinutes().toString().padStart(2, '0'); horaEl.textContent = `${h}:${m}`; }
    const infoAlternadaManager = {
      informacoes: [], infoIndex: 0,
      async buscarCotacoes() { try { const res = await fetch('https://economia.awesomeapi.com.br/last/USD-BRL,EUR-BRL,BTC-BRL'); const data = await res.json(); const dolar = parseFloat(data.USDBRL.bid).toFixed(2); const euro = parseFloat(data.EURBRL.bid).toFixed(2); const bitcoin = parseFloat(data.BTCBRL.bid).toFixed(0); const variacaoDolar = parseFloat(data.USDBRL.pctChange).toFixed(2); const variacaoEuro = parseFloat(data.EURBRL.pctChange).toFixed(2); const variacaoBTC = parseFloat(data.BTCBRL.pctChange).toFixed(2); this.informacoes = [`<div style="display: flex; align-items: center; gap: 8px;"><img src='https://cdn-icons-png.flaticon.com/512/3358/3358623.png' class='icon-decorado' alt='Ícone Câmbio'><span style="font-size: 12px; color: #ccc; font-weight: 600;">CÂMBIO</span><span>Dólar:</span><span style="font-weight: bold;">R$ ${dolar}</span><span style="background-color: ${variacaoDolar >= 0 ? '#2ecc71' : '#e74c3c'}; color: white; font-size: 11px; padding: 2px 6px; border-radius: 4px;">${variacaoDolar}%</span><span>Euro:</span><span style="font-weight: bold;">R$ ${euro}</span><span style="background-color: ${variacaoEuro >= 0 ? '#2ecc71' : '#e74c3c'}; color: white; font-size: 11px; padding: 2px 6px; border-radius: 4px;">${variacaoEuro}%</span></div>`, `<div style="display: flex; align-items: center; gap: 8px;"><img src='https://cdn-icons-png.flaticon.com/512/825/825519.png' class='icon-decorado' alt='Ícone Cripto'><span style="font-size: 12px; color: #ccc; font-weight: 600;">CRIPTOMOEDA</span><span>Bitcoin:</span><span style="font-weight: bold;">R$ ${bitcoin}</span><span style="background-color: ${variacaoBTC >= 0 ? '#2ecc71' : '#e74c3c'}; color: white; font-size: 11px; padding: 2px 6px; border-radius: 4px;">${variacaoBTC}%</span></div>`]; } catch (e) { console.error('Erro ao buscar cotações:', e); this.informacoes = [`<span style="color: red">Erro ao carregar cotações.</span>`]; } }, 
      atualizarPainel() { if (this.informacoes.length === 0) return; infoAlternadaEl.style.opacity = 0; setTimeout(() => { infoAlternadaEl.innerHTML = this.informacoes[this.infoIndex]; infoAlternadaEl.style.opacity = 1; this.infoIndex = (this.infoIndex + 1) % this.informacoes.length; }, 500); }, 
      start() { this.buscarCotacoes(); setInterval(() => this.buscarCotacoes(), 300000); setTimeout(() => { this.atualizarPainel(); setInterval(() => this.atualizarPainel(), 4000); }, 1000); }
    };
    
    // --- INICIALIZAÇÃO PADRÃO ---
    function startPlayerLogic() {
      atualizarHora();
      setInterval(atualizarHora, 60000);
      infoAlternadaManager.start();
    }

    // ========================================================================
    // --- BLOCO UNIVERSAL PARA CONTEÚDO DINÂMICO ---
    // ========================================================================
    document.addEventListener('DOMContentLoaded', () => {
        const dynamicContent = localStorage.getItem('dynamicContent');
        const dynamicFormat = localStorage.getItem('dynamicFormat');

        if (dynamicContent) {
            const mediaContainer = document.getElementById('mainMediaWrapper');
            if (mediaContainer) {
                const videoTag = mediaContainer.querySelector('video');
                const fallbackImg = mediaContainer.querySelector('#fallback');
                if (videoTag) videoTag.style.display = 'none';
                if (fallbackImg) fallbackImg.style.display = 'none';

                const contentWrapper = document.createElement('div');
                contentWrapper.style.cssText = 'position:absolute; top:0; left:0; width:100%; height:100%; z-index:1; overflow:hidden;';
                contentWrapper.innerHTML = dynamicContent;

                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:absolute; top:0; left:0; width:100%; height:100%; z-index:2;';

                mediaContainer.appendChild(contentWrapper);
                mediaContainer.appendChild(overlay);
            }
            localStorage.removeItem('dynamicContent');
            localStorage.removeItem('dynamicFormat');
        } else {
            startPlayerLogic();
        }
    });

    window.onload = function() {
        const content = localStorage.getItem('dynamicContent');
        const scriptSrc = localStorage.getItem('dynamicScript');
        const container = document.getElementById('media-container'); // Assumindo que seu container tem o id 'media-container'

        if (content && container) {
            container.innerHTML = content;
            localStorage.removeItem('dynamicContent');

            if (scriptSrc) {
                // Se um script precisa ser carregado (para o Instagram)
                const scriptTag = document.createElement('script');
                scriptTag.async = true;
                scriptTag.src = scriptSrc;
                document.body.appendChild(scriptTag);
                localStorage.removeItem('dynamicScript');
            }
        }
    };
</script>
</body>
</html>
